<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard de Monitoreo en Tiempo Real</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      #logs {
        border: 1px solid #dee2e6;
        background-color: #fff;
        padding: 1rem;
        height: 150px;
        overflow-y: scroll;
        font-family: monospace;
        font-size: 0.9rem;
      }
      .card-header,
      .card-title {
        color: #0d6efd;
      }
      .badge {
        transition: background-color 0.3s ease-in-out;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <header class="text-center mb-4">
        <h1 class="display-5">Dashboard de Monitoreo</h1>
        <p class="lead">
          Suscríbete a dispositivos para ver sus datos de sensores en vivo.
        </p>
      </header>

      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Suscripción a Dispositivos</h5>
          <div class="input-group">
            <input
              type="text"
              id="deviceIdInput"
              class="form-control"
              placeholder="Ej: ESP32_1 o ESP32_2"
              value="ESP32_1"
            />
            <button id="subscribeBtn" class="btn btn-primary">
              <i class="bi bi-plus-circle"></i> Suscribirse
            </button>
          </div>
        </div>
      </div>

      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Configuración de Umbrales</h5>
          <form id="thresholdForm" class="row g-3 align-items-end">
            <div class="col-md-3">
              <label for="thresholdDeviceInput" class="form-label"
                >Dispositivo</label
              >
              <input
                type="text"
                id="thresholdDeviceInput"
                class="form-control"
                placeholder="Ej: ESP32_1"
                list="devicesDatalist"
              />
              <datalist id="devicesDatalist"></datalist>
            </div>
            <div class="col-md-3">
              <label for="sensorTypeSelect" class="form-label">Sensor</label>
              <select id="sensorTypeSelect" class="form-select">
                <option value="temperature">Temperatura</option>
                <option value="humidity">Humedad</option>
                <option value="soil_humidity">Humedad del Suelo</option>
                <option value="solar_radiation">Radiación Solar</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="minThresholdInput" class="form-label"
                >Umbral Mínimo</label
              >
              <input
                type="number"
                step="any"
                id="minThresholdInput"
                class="form-control"
                placeholder="Ej: 15"
              />
              <small id="minThresholdHelp" class="form-text text-muted">
                Define el mínimo permitido para el sensor seleccionado.
              </small>
            </div>
            <div class="col-md-2">
              <label for="maxThresholdInput" class="form-label"
                >Umbral Máximo</label
              >
              <input
                type="number"
                step="any"
                id="maxThresholdInput"
                class="form-control"
                placeholder="Ej: 35"
              />
              <small id="maxThresholdHelp" class="form-text text-muted">
                Define el máximo permitido para el sensor seleccionado.
              </small>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-success w-100 mt-4 mt-md-0">
                <i class="bi bi-save"></i> Guardar
              </button>
            </div>
          </form>
          <small class="text-muted"
            >Deja en blanco un valor para quitar el umbral
            correspondiente.</small
          >
        </div>
      </div>

      <div id="devices-container"></div>

      <div class="mt-4">
        <h5>Log de Conexión:</h5>
        <div id="logs"></div>
      </div>
    </div>

    <script>
      const logs = document.getElementById("logs");
      const deviceIdInput = document.getElementById("deviceIdInput");
      const subscribeBtn = document.getElementById("subscribeBtn");
      const devicesContainer = document.getElementById("devices-container");
      const subscribedDevices = new Set();
      const thresholdForm = document.getElementById("thresholdForm");
      const sensorTypeSelect = document.getElementById("sensorTypeSelect");
      const minThresholdInput = document.getElementById("minThresholdInput");
      const maxThresholdInput = document.getElementById("maxThresholdInput");
      const thresholdDeviceInput = document.getElementById(
        "thresholdDeviceInput"
      );
      const devicesDatalist = document.getElementById("devicesDatalist");
      const minThresholdHelp = document.getElementById("minThresholdHelp");
      const maxThresholdHelp = document.getElementById("maxThresholdHelp");

      const SENSOR_METADATA = {
        temperature: {
          name: "Temperatura",
          icon: '<i class="bi bi-thermometer-half text-danger"></i>',
          unit: "°C",
          decimals: 2,
          examples: { min: 15, max: 35 },
        },
        humidity: {
          name: "Humedad",
          icon: '<i class="bi bi-droplet-half text-info"></i>',
          unit: "%",
          decimals: 2,
          examples: { min: 40, max: 90 },
        },
        soil_humidity: {
          name: "Humedad del Suelo",
          icon: '<i class="bi bi-flower3 text-success"></i>',
          unit: "%",
          decimals: 2,
          examples: { min: 30, max: 80 },
        },
        solar_radiation: {
          name: "Radiación Solar",
          icon: '<i class="bi bi-brightness-high text-warning"></i>',
          unit: "W/m²",
          decimals: 0,
          examples: { max: 1000 },
        },
      };

      const knownDevices = new Set(["ESP32_1", "ESP32_2"]);

      function refreshDeviceSuggestions() {
        if (!devicesDatalist) return;
        devicesDatalist.innerHTML = Array.from(knownDevices)
          .sort()
          .map((device) => `<option value="${device}"></option>`)
          .join("");
      }

      function registerKnownDevice(deviceId) {
        const sanitized = deviceId?.trim();
        if (!sanitized) return;
        if (!knownDevices.has(sanitized)) {
          knownDevices.add(sanitized);
          refreshDeviceSuggestions();
        }
        if (thresholdDeviceInput && !thresholdDeviceInput.value) {
          thresholdDeviceInput.value = sanitized;
        }
      }

      refreshDeviceSuggestions();
      if (thresholdDeviceInput && !thresholdDeviceInput.value) {
        thresholdDeviceInput.value = "ESP32_1";
      }

      if (sensorTypeSelect) {
        const currentValue = sensorTypeSelect.value;
        sensorTypeSelect.innerHTML = Object.entries(SENSOR_METADATA)
          .map(
            ([value, meta]) => `<option value="${value}">${meta.name}</option>`
          )
          .join("");
        if (SENSOR_METADATA[currentValue]) {
          sensorTypeSelect.value = currentValue;
        }
        sensorTypeSelect.addEventListener("change", updateThresholdHints);
      }

      updateThresholdHints();

      // const WS_URL = "ws://34.227.8.130:3000";
      const WS_URL = "ws://localhost:3000";

      const socket = new WebSocket(WS_URL);

      socket.onopen = () => {
        logMessage("Conectado al servidor WebSocket.");
      };

      socket.onclose = (event) => {
        logMessage(`Desconectado del servidor (${event.code}).`);
      };

      socket.onerror = (err) => {
        logMessage(`Error en WebSocket: ${err.message || err}`);
      };

      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);

          if (data.event === "newSensorData") {
            const sensorData = data.data;
            const { deviceId, sensorType, value, unit } = sensorData;
            registerKnownDevice(deviceId);
            updateSensorCard(deviceId, sensorType, value, unit);
          } else if (data.event === "sensorAlert") {
            const { deviceId, message } = data;
            showNotification(`Alerta en ${deviceId}`, message);
            logMessage(`${message}`);
          } else if (data.event === "ack") {
            logMessage(data.message);
          } else if (data.event === "thresholdsUpdated") {
            const { deviceId, sensorType, thresholds } = data;
            registerKnownDevice(deviceId);
            const sensorLabel = getSensorName(sensorType);
            const minLabel =
              thresholds && thresholds.min !== undefined
                ? formatSensorValue(sensorType, thresholds.min)
                : "sin mínimo";
            const maxLabel =
              thresholds && thresholds.max !== undefined
                ? formatSensorValue(sensorType, thresholds.max)
                : "sin máximo";
            logMessage(
              `Umbrales para ${deviceId} / ${sensorLabel} actualizados: ${minLabel} / ${maxLabel}`
            );
          } else if (data.event === "thresholdUpdateError") {
            logMessage(`Error al actualizar umbrales: ${data.message}`);
            alert(data.message);
          } else if (data.event === "dataError") {
            logMessage("Error del servidor: " + data.message);
          }
        } catch (err) {
          console.error("Error procesando mensaje:", err, event.data);
        }
      };

      // --- SUSCRIPCIÓN A DISPOSITIVOS ---
      subscribeBtn.addEventListener("click", () => {
        const deviceId = deviceIdInput.value.trim();
        if (!deviceId) return alert("Introduce un ID de dispositivo.");
        if (subscribedDevices.has(deviceId)) {
          logMessage(`Ya estás suscrito a ${deviceId}`);
          return;
        }

        const msg = JSON.stringify({
          event: "subscribeToDevice",
          deviceId,
        });
        socket.send(msg);
        logMessage(`Suscrito a: ${deviceId}`);

        registerKnownDevice(deviceId);
        createDeviceCard(deviceId);
        subscribedDevices.add(deviceId);
        deviceIdInput.value = "";
      });

      deviceIdInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") subscribeBtn.click();
      });

      thresholdForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const deviceId = thresholdDeviceInput
          ? thresholdDeviceInput.value.trim()
          : "";
        if (!deviceId) {
          alert("Selecciona un dispositivo para configurar umbrales.");
          return;
        }
        const sensorType = sensorTypeSelect.value;
        const isMinDisabled = !!minThresholdInput?.disabled;
        const minValue = minThresholdInput.value.trim();
        const maxValue = maxThresholdInput.value.trim();

        const payload = {
          event: "updateThresholds",
          sensorType,
          deviceId,
        };

        if (!isMinDisabled && minValue !== "") {
          const parsedMin = Number(minValue);
          if (Number.isNaN(parsedMin)) {
            alert("El umbral mínimo debe ser un número válido.");
            return;
          }
          payload.min = parsedMin;
        }

        if (maxValue !== "") {
          const parsedMax = Number(maxValue);
          if (Number.isNaN(parsedMax)) {
            alert("El umbral máximo debe ser un número válido.");
            return;
          }
          payload.max = parsedMax;
        }

        if (
          payload.min !== undefined &&
          payload.max !== undefined &&
          payload.min !== undefined &&
          payload.max !== undefined &&
          payload.min > payload.max
        ) {
          alert("El umbral mínimo no puede ser mayor al máximo.");
          return;
        }

        registerKnownDevice(deviceId);
        socket.send(JSON.stringify(payload));
        logMessage(
          `Configurando umbrales para ${deviceId} / ${getSensorName(
            sensorType
          )}...`
        );
      });

      // --- CREACIÓN DE TARJETAS DE DISPOSITIVOS ---
      function createDeviceCard(deviceId) {
        if (document.getElementById(`device-${deviceId}`)) return;

        registerKnownDevice(deviceId);

        const card = document.createElement("div");
        card.className = "card mb-3 shadow-sm";
        card.id = `device-${deviceId}`;
        card.innerHTML = `
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Dispositivo: <strong>${deviceId}</strong></span>
            <button class="btn btn-sm btn-outline-danger" onclick="unsubscribe('${deviceId}')">
              <i class="bi bi-x-circle"></i> Dejar de seguir
            </button>
          </div>
          <div class="card-body">
            <h5 class="card-title">Lecturas de Sensores</h5>
            <ul class="list-group list-group-flush" id="sensors-list-${deviceId}"></ul>
          </div>
        `;
        devicesContainer.appendChild(card);
      }

      function unsubscribe(deviceId) {
        if (!subscribedDevices.has(deviceId)) return;
        socket.send(
          JSON.stringify({ event: "unsubscribeFromDevice", deviceId })
        );
        subscribedDevices.delete(deviceId);
        document.getElementById(`device-${deviceId}`)?.remove();
        logMessage(`Desuscrito de ${deviceId}`);
      }

      function updateSensorCard(deviceId, sensorType, value, unit) {
        registerKnownDevice(deviceId);
        if (!subscribedDevices.has(deviceId)) return;

        const sensorList = document.getElementById(`sensors-list-${deviceId}`);
        if (!sensorList) return;

        let sensorItem = document.getElementById(
          `sensor-${deviceId}-${sensorType}`
        );

        if (!sensorItem) {
          sensorItem = document.createElement("li");
          sensorItem.className =
            "list-group-item d-flex justify-content-between align-items-center";
          sensorItem.id = `sensor-${deviceId}-${sensorType}`;
          const icon = getSensorIcon(sensorType);
          const name = getSensorName(sensorType);
          const formattedValue = formatSensorValue(sensorType, value, unit);

          sensorItem.innerHTML = `
            <span>${icon} <strong class="ms-2">${name}:</strong></span>
            <span class="badge bg-primary rounded-pill fs-6" id="value-${deviceId}-${sensorType}">
              ${formattedValue}
            </span>`;
          sensorList.appendChild(sensorItem);
        } else {
          const badge = document.getElementById(
            `value-${deviceId}-${sensorType}`
          );
          badge.textContent = formatSensorValue(sensorType, value, unit);
          badge.classList.replace("bg-primary", "bg-success");
          setTimeout(
            () => badge.classList.replace("bg-success", "bg-primary"),
            500
          );
        }
      }

      // --- NOTIFICACIONES ---
      document.addEventListener("DOMContentLoaded", () => {
        if ("Notification" in window && Notification.permission !== "granted") {
          Notification.requestPermission();
        }
      });

      function showNotification(title, body) {
        if (Notification.permission === "granted") {
          new Notification(title, { body });
        }
      }

      // --- UTILS ---
      function getSensorUnit(type, fallbackUnit = "") {
        return SENSOR_METADATA[type]?.unit || fallbackUnit || "";
      }

      function formatSensorValue(sensorType, value, fallbackUnit = "") {
        const meta = SENSOR_METADATA[sensorType];
        const decimals = meta?.decimals ?? 2;
        const numericValue = typeof value === "number" ? value : Number(value);
        const formattedValue = Number.isFinite(numericValue)
          ? numericValue.toFixed(decimals)
          : String(value);
        const unitLabel = getSensorUnit(sensorType, fallbackUnit);
        return unitLabel ? `${formattedValue} ${unitLabel}` : formattedValue;
      }

      function getSensorName(type) {
        return SENSOR_METADATA[type]?.name || type;
      }

      function getSensorIcon(type) {
        return (
          SENSOR_METADATA[type]?.icon || '<i class="bi bi-cpu text-muted"></i>'
        );
      }

      function updateThresholdHints() {
        if (!sensorTypeSelect) return;
        const selectedType = sensorTypeSelect.value;
        const meta = SENSOR_METADATA[selectedType] || {};
        const sensorName = meta.name || selectedType;
        const unitLabel = meta.unit || "";
        const examples = meta.examples || {};
        const disableMin = selectedType === "solar_radiation";

        if (minThresholdInput) {
          minThresholdInput.disabled = disableMin;
          if (disableMin) {
            minThresholdInput.value = "";
            minThresholdInput.placeholder = "No aplica";
          } else {
            minThresholdInput.placeholder =
              examples.min !== undefined ? `Ej: ${examples.min}` : "Ej: 15";
          }
        }

        if (maxThresholdInput) {
          maxThresholdInput.placeholder =
            examples.max !== undefined ? `Ej: ${examples.max}` : "Ej: 35";
        }

        if (minThresholdHelp) {
          if (disableMin) {
            minThresholdHelp.textContent = `No se requiere mínimo para ${sensorName}.`;
          } else {
            minThresholdHelp.textContent = unitLabel
              ? `Define el valor mínimo permitido para ${sensorName} en ${unitLabel}.`
              : `Define el valor mínimo permitido para ${sensorName}.`;
          }
        }

        if (maxThresholdHelp) {
          maxThresholdHelp.textContent = unitLabel
            ? `Define el valor máximo permitido para ${sensorName} en ${unitLabel}.`
            : `Define el valor máximo permitido para ${sensorName}.`;
        }
      }

      function logMessage(message) {
        const p = document.createElement("p");
        p.className = "mb-1";
        p.innerHTML = `<code>[${new Date().toLocaleTimeString()}]</code> ${message}`;
        logs.appendChild(p);
        logs.scrollTop = logs.scrollHeight;
      }
    </script>
  </body>
</html>
