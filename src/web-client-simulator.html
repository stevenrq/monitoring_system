<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Dashboard de Monitoreo en Tiempo Real</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link href="./web-client-simulator.css" rel="stylesheet" />
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
  </head>
  <body class="sim-body">
    <div class="container-fluid py-4 px-3 px-xl-5">
      <header class="dashboard-hero text-center mb-5">
        <span class="badge text-bg-primary rounded-pill shadow-sm px-3 py-2">
          Simulador de pruebas
        </span>
        <h1 class="mt-3">Panel de monitoreo en tiempo real</h1>
        <p class="lead text-muted">
          Configura el backend, gestiona plantas y dispara alertas sin depender
          del hardware físico.
        </p>
      </header>

      <div class="row g-4">
        <div class="col-12 col-xxl-7 d-flex flex-column gap-4">
          <section class="panel panel-highlight">
            <div class="panel-header">
              <div>
                <h5>Conexión y autenticación</h5>
                <p class="text-muted mb-0">
                  Define la API, WebSocket y obtén un token válido para probar
                  los servicios protegidos.
                </p>
              </div>
            </div>
            <div class="row g-4">
              <div class="col-lg-6">
                <div class="subpanel">
                  <div class="subpanel-title">
                    <i class="bi bi-diagram-3 text-primary me-2"></i>Backend &
                    WebSocket
                  </div>
                  <form class="row g-3 align-items-end" id="settingsForm">
                    <div class="col-12">
                      <div
                        class="d-flex justify-content-between align-items-center"
                      >
                        <label class="form-label mb-0" for="environmentToggle"
                          >Entorno</label
                        >
                        <div class="form-check form-switch m-0">
                          <input
                            class="form-check-input"
                            id="environmentToggle"
                            role="switch"
                            type="checkbox"
                          />
                          <label
                            class="form-check-label"
                            for="environmentToggle"
                          >
                            <span id="environmentLabel">Desarrollo</span>
                          </label>
                        </div>
                      </div>
                      <small class="text-muted"
                        >Desarrollo usa localhost:3000 y producción el servidor
                        EC2.</small
                      >
                    </div>
                    <div class="col-12">
                      <label class="form-label" for="apiBaseInput"
                        >API Base URL</label
                      >
                      <input
                        class="form-control"
                        id="apiBaseInput"
                        placeholder="http://localhost:3000/api"
                        type="url"
                      />
                    </div>
                    <div class="col-12">
                      <label class="form-label" for="wsUrlInput"
                        >WebSocket URL</label
                      >
                      <input
                        class="form-control"
                        id="wsUrlInput"
                        placeholder="ws://localhost:3000"
                        type="url"
                      />
                    </div>
                    <div class="col-9">
                      <label class="form-label" for="authTokenInput"
                        >Access Token (Bearer)</label
                      >
                      <input
                        autocomplete="off"
                        class="form-control"
                        id="authTokenInput"
                        placeholder="jwt..."
                        type="text"
                      />
                    </div>
                    <div class="col-3 d-grid">
                      <button class="btn btn-primary" type="submit">
                        <i class="bi bi-cloud-check"></i> Guardar
                      </button>
                    </div>
                  </form>
                  <small class="text-muted"
                    >Los cambios se almacenan en tu navegador.</small
                  >
                </div>
              </div>
              <div class="col-lg-6">
                <div class="subpanel h-100">
                  <div class="subpanel-title">
                    <i class="bi bi-shield-lock text-primary me-2"></i>Inicio de
                    sesión rápido
                  </div>
                  <form class="row g-3 align-items-end" id="loginForm">
                    <div class="col-12">
                      <label class="form-label" for="loginUsernameInput"
                        >Usuario</label
                      >
                      <input
                        autocomplete="username"
                        class="form-control"
                        id="loginUsernameInput"
                        placeholder="admin"
                        required
                        type="text"
                      />
                    </div>
                    <div class="col-12">
                      <label class="form-label" for="loginPasswordInput"
                        >Contraseña</label
                      >
                      <input
                        autocomplete="current-password"
                        class="form-control"
                        id="loginPasswordInput"
                        placeholder="••••••••"
                        required
                        type="password"
                      />
                    </div>
                    <div class="col-12 d-grid">
                      <button class="btn btn-dark" type="submit">
                        <i class="bi bi-door-open"></i> Iniciar sesión
                      </button>
                    </div>
                    <div class="col-12">
                      <div class="text-muted small" id="loginStatus"></div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header">
              <div>
                <h5>Cliente FCM integrado</h5>
                <p class="text-muted mb-0">
                  Inicializa Firebase, solicita permisos y genera tokens web sin
                  salir del panel.
                </p>
              </div>
            </div>
            <form class="row g-3" id="firebaseConfigForm">
              <div class="col-md-6 col-xl-4">
                <label class="form-label" for="firebaseApiKeyInput"
                  >API Key</label
                >
                <input
                  class="form-control"
                  id="firebaseApiKeyInput"
                  placeholder="AIza..."
                  type="text"
                />
              </div>
              <div class="col-md-6 col-xl-4">
                <label class="form-label" for="firebaseAuthDomainInput"
                  >Auth Domain</label
                >
                <input
                  class="form-control"
                  id="firebaseAuthDomainInput"
                  placeholder="mi-app.firebaseapp.com"
                  type="text"
                />
              </div>
              <div class="col-md-6 col-xl-4">
                <label class="form-label" for="firebaseProjectIdInput"
                  >Project ID</label
                >
                <input
                  class="form-control"
                  id="firebaseProjectIdInput"
                  placeholder="mi-app"
                  type="text"
                />
              </div>
              <div class="col-md-6 col-xl-4">
                <label class="form-label" for="firebaseStorageBucketInput"
                  >Storage Bucket</label
                >
                <input
                  class="form-control"
                  id="firebaseStorageBucketInput"
                  placeholder="mi-app.appspot.com"
                  type="text"
                />
              </div>
              <div class="col-md-6 col-xl-4">
                <label class="form-label" for="firebaseSenderIdInput"
                  >Messaging Sender ID</label
                >
                <input
                  class="form-control"
                  id="firebaseSenderIdInput"
                  placeholder="1234567890"
                  type="text"
                />
              </div>
              <div class="col-md-6 col-xl-4">
                <label class="form-label" for="firebaseAppIdInput"
                  >App ID</label
                >
                <input
                  class="form-control"
                  id="firebaseAppIdInput"
                  placeholder="1:1234567890:web:abc123"
                  type="text"
                />
              </div>
              <div class="col-md-6 col-xl-4">
                <label class="form-label" for="firebaseMeasurementIdInput"
                  >Measurement ID (opcional)</label
                >
                <input
                  class="form-control"
                  id="firebaseMeasurementIdInput"
                  placeholder="G-XXXXXXX"
                  type="text"
                />
              </div>
              <div class="col-md-6 col-xl-4">
                <label class="form-label" for="firebaseVapidKeyInput"
                  >VAPID key pública</label
                >
                <input
                  class="form-control"
                  id="firebaseVapidKeyInput"
                  placeholder="BNc..."
                  type="text"
                />
              </div>
              <div class="col-md-6 col-xl-4 d-grid">
                <button class="btn btn-outline-primary mt-md-4" type="submit">
                  <i class="bi bi-save2"></i> Guardar configuración
                </button>
              </div>
            </form>
            <div class="row g-3 align-items-end mt-1">
              <div class="col-md-4 d-grid">
                <button class="btn btn-primary" id="firebaseInitBtn">
                  <i class="bi bi-rocket"></i> Inicializar cliente
                </button>
              </div>
              <div class="col-md-4 d-grid">
                <button
                  class="btn btn-outline-secondary"
                  id="firebasePermissionBtn"
                >
                  <i class="bi bi-bell"></i> Solicitar permiso
                </button>
              </div>
              <div class="col-md-4 d-grid">
                <button class="btn btn-success" id="firebaseGetTokenBtn">
                  <i class="bi bi-cloud-arrow-down"></i> Obtener token web
                </button>
              </div>
              <div class="col-12">
                <div class="text-muted small" id="firebaseStatus"></div>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header">
              <div>
                <h5>Gestión de plantas y umbrales</h5>
                <p class="text-muted mb-0">
                  Aplica los umbrales a cada sensor y mantenlos sincronizados
                  con el motor de alertas. Solo <strong>ESP32_1</strong> envía notificaciones en tiempo real; <strong>ESP32_2</strong> se reserva para reportes históricos.
                </p>
              </div>
            </div>
            <form class="row g-3" id="plantForm">
              <div class="col-md-4">
                <label class="form-label" for="plantNameInput">Nombre</label>
                <input
                  class="form-control"
                  id="plantNameInput"
                  placeholder="Ej: Lavanda demo"
                  required
                  type="text"
                />
              </div>
              <div class="col-md-4">
                <label class="form-label" for="plantDeviceInput"
                  >Dispositivo asignado</label
                >
                <input
                  class="form-control"
                  id="plantDeviceInput"
                  list="devicesDatalist"
                  placeholder="ESP32_1"
                  type="text"
                />
              </div>
              <div class="col-md-4">
                <label class="form-label">Umbrales iniciales</label>
                <div class="small text-muted">
                  Ajusta los valores por sensor antes de registrar la planta.
                </div>
              </div>
              <div class="col-12">
                <div class="table-responsive panel-table">
                  <table class="table table-sm align-middle mb-0">
                    <thead>
                      <tr>
                        <th>Sensor</th>
                        <th>Umbral mínimo</th>
                        <th>Umbral máximo</th>
                      </tr>
                    </thead>
                    <tbody id="plantThresholdsBody"></tbody>
                  </table>
                </div>
              </div>
              <div class="col-md-3">
                <button class="btn btn-success w-100" id="plantSubmitBtn" type="submit">
                  <i class="bi bi-plant"></i> Crear planta
                </button>
              </div>
              <div class="col-md-3 d-none" id="plantCancelEditCol">
                <button
                  class="btn btn-outline-danger w-100"
                  id="plantCancelEditBtn"
                  type="button"
                >
                  <i class="bi bi-x-circle"></i> Cancelar edición
                </button>
              </div>
              <div class="col-md-3">
                <button
                  class="btn btn-outline-secondary w-100"
                  id="refreshPlantsBtn"
                  type="button"
                >
                  <i class="bi bi-arrow-repeat"></i> Actualizar listado
                </button>
              </div>
              <div class="col-12">
                <div class="text-muted small" id="plantStatus"></div>
              </div>
            </form>
            <div class="table-responsive panel-table mt-3">
              <table class="table table-bordered align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Nombre</th>
                    <th>Dispositivo</th>
                    <th>Umbrales configurados</th>
                    <th>Actualización</th>
                    <th class="text-center" style="width: 200px;">Acciones</th>
                  </tr>
                </thead>
                <tbody id="plantsTableBody">
                  <tr>
                    <td class="text-center text-muted" colspan="5">
                      Aún no hay plantas cargadas.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header">
              <div>
                <h5>Registro de tokens FCM</h5>
                <p class="text-muted mb-0">
                  Asocia tokens de Android, iOS o web al backend para recibir
                  alertas push.
                </p>
              </div>
            </div>
            <form class="row g-3 align-items-end" id="fcmForm">
              <div class="col-md-4">
                <label class="form-label" for="fcmTokenInput">Token FCM</label>
                <input
                  class="form-control"
                  id="fcmTokenInput"
                  placeholder="token generado por Firebase"
                  required
                  type="text"
                />
              </div>
              <div class="col-md-3">
                <label class="form-label" for="fcmDeviceIdInput"
                  >ID de dispositivo</label
                >
                <input
                  class="form-control"
                  id="fcmDeviceIdInput"
                  list="devicesDatalist"
                  placeholder="ESP32_1"
                  type="text"
                />
              </div>
              <div class="col-md-3">
                <label class="form-label" for="fcmPlatformInput"
                  >Plataforma</label
                >
                <select class="form-select" id="fcmPlatformInput">
                  <option value="">Detectar automáticamente</option>
                  <option value="android">Android</option>
                  <option value="ios">iOS</option>
                  <option value="web">Web</option>
                  <option value="other">Otra</option>
                </select>
              </div>
              <div class="col-md-2">
                <button class="btn btn-primary w-100" type="submit">
                  <i class="bi bi-bell-fill"></i> Registrar
                </button>
              </div>
              <div class="col-12">
                <div class="text-muted small" id="fcmStatus">Solo los dispositivos registrados como ESP32_1 recibirán estas alertas push.</div>
              </div>
            </form>
          </section>
        </div>

        <div class="col-12 col-xxl-5 d-flex flex-column gap-4">
          <section class="panel h-100">
            <div class="panel-header">
              <div>
                <h5>Operaciones en tiempo real</h5>
                <p class="text-muted mb-0">
                  Suscríbete, ajusta umbrales o envía lecturas para disparar
                  alertas.
                </p>
              </div>
            </div>
            <div class="subpanel mb-3">
              <div class="subpanel-title">
                <i class="bi bi-plug text-primary me-2"></i>Suscripción a
                dispositivos
              </div>
              <div class="input-group">
                <input
                  class="form-control"
                  id="deviceIdInput"
                  placeholder="Ej: ESP32_1 o ESP32_2"
                  type="text"
                  value="ESP32_1"
                />
                <button class="btn btn-primary" id="subscribeBtn">
                  <i class="bi bi-plus-circle"></i> Suscribirse
                </button>
              </div>
            </div>
            <div class="subpanel mb-3">
              <div class="subpanel-title">
                <i class="bi bi-sliders text-primary me-2"></i>Configuración
                manual de umbrales
              </div>
              <form class="row g-3 align-items-end" id="thresholdForm">
                <div class="col-lg-4">
                  <label class="form-label" for="thresholdDeviceInput"
                    >Dispositivo</label
                  >
                  <input
                    class="form-control"
                    id="thresholdDeviceInput"
                    list="devicesDatalist"
                    placeholder="ESP32_1"
                    type="text"
                  />
                  <datalist id="devicesDatalist"></datalist>
                </div>
                <div class="col-lg-4">
                  <label class="form-label" for="sensorTypeSelect"
                    >Sensor</label
                  >
                  <select class="form-select" id="sensorTypeSelect">
                    <option value="temperature">Temperatura</option>
                    <option value="humidity">Humedad</option>
                    <option value="soil_humidity">Humedad del Suelo</option>
                    <option value="solar_radiation">Radiación Solar</option>
                  </select>
                </div>
                <div class="col-lg-2">
                  <label class="form-label" for="minThresholdInput"
                    >Mínimo</label
                  >
                  <input
                    class="form-control"
                    id="minThresholdInput"
                    placeholder="Ej: 15"
                    step="any"
                    type="number"
                  />
                </div>
                <div class="col-lg-2">
                  <label class="form-label" for="maxThresholdInput"
                    >Máximo</label
                  >
                  <input
                    class="form-control"
                    id="maxThresholdInput"
                    placeholder="Ej: 35"
                    step="any"
                    type="number"
                  />
                </div>
                <div class="col-12 d-flex flex-column flex-md-row gap-3">
                  <small class="text-muted flex-fill" id="minThresholdHelp">
                    Define el mínimo permitido.
                  </small>
                  <small class="text-muted flex-fill" id="maxThresholdHelp">
                    Define el máximo permitido.
                  </small>
                </div>
                <div class="col-md-3 ms-auto">
                  <button class="btn btn-success w-100" type="submit">
                    <i class="bi bi-save"></i> Guardar
                  </button>
                </div>
              </form>
            </div>
            <div class="subpanel">
              <div class="subpanel-title">
                <i class="bi bi-activity text-primary me-2"></i>Simulador de
                lecturas
              </div>
              <p class="text-muted small mb-3">
                Envía lecturas por WebSocket para disparar los umbrales
                definidos por tus plantas con el fin de probar las
                notificaciones. Recuerda que solo <strong>ESP32_1</strong>
                generará alertas en tiempo real.
              </p>
              <form class="row g-3 align-items-end" id="sensorForm">
                <div class="col-lg-4">
                  <label class="form-label" for="sensorDeviceInput"
                    >Dispositivo</label
                  >
                  <input
                    class="form-control"
                    id="sensorDeviceInput"
                    list="devicesDatalist"
                    placeholder="ESP32_1"
                    required
                    type="text"
                  />
                </div>
                <div class="col-lg-4">
                  <label class="form-label" for="sensorTypeSimulation"
                    >Sensor</label
                  >
                  <select class="form-select" id="sensorTypeSimulation">
                    <option value="temperature">Temperatura</option>
                    <option value="humidity">Humedad</option>
                    <option value="soil_humidity">Humedad del Suelo</option>
                    <option value="solar_radiation">Radiación Solar</option>
                  </select>
                </div>
                <div class="col-lg-2">
                  <label class="form-label" for="sensorValueInput">Valor</label>
                  <input
                    class="form-control"
                    id="sensorValueInput"
                    placeholder="Ej: 32"
                    required
                    step="any"
                    type="number"
                  />
                </div>
                <div class="col-lg-2">
                  <label class="form-label" for="sensorUnitInput">Unidad</label>
                  <input
                    class="form-control"
                    id="sensorUnitInput"
                    placeholder="°C"
                    type="text"
                  />
                </div>
                <div class="col-md-3 ms-auto">
                  <button class="btn btn-warning w-100" type="submit">
                    <i class="bi bi-send"></i> Enviar
                  </button>
                </div>
                <div class="col-12">
                  <div class="text-muted small" id="sensorStatus"></div>
                </div>
              </form>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header">
              <div>
                <h5>Dispositivos suscritos</h5>
                <p class="text-muted mb-0">
                  Visualiza las últimas lecturas recibidas.
                </p>
              </div>
            </div>
            <div class="device-grid" id="devices-container"></div>
          </section>

          <section class="panel">
            <div class="panel-header">
              <div>
                <h5>Alertas recientes</h5>
                <p class="text-muted mb-0">
                  Incluye el contexto de la planta y el umbral disparado.
                </p>
              </div>
            </div>
            <div class="list-group small alert-list" id="alertsList">
              <div class="list-group-item text-muted text-center">
                Aún no se han recibido alertas.
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header">
              <div>
                <h5>Bitácora en vivo</h5>
                <p class="text-muted mb-0">
                  Revisa las acciones y eventos recibidos del servidor.
                </p>
              </div>
            </div>
            <div class="log-console" id="logs"></div>
          </section>
        </div>
      </div>
    </div>
    <script type="module" src="./web-client-simulator.js"></script>
  </body>
</html>
